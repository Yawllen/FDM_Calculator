# CLI Calculator

Командная утилита для расчёта стоимости и времени FDM-печати на основе 3D-моделей (STL / 3MF).

CLI является **тонкой оболочкой** над вычислительным ядром `core_calc.py` и не содержит бизнес-логики.
Все формулы, правила и расчёты находятся в ядре.

---

## Назначение

CLI предназначен для:
- локальных расчётов стоимости печати,
- серверного использования (batch / автоматизация),
- интеграции в другие сервисы (через JSON-вывод),
- регрессионной проверки ядра (golden tests).

CLI **не является** источником расчётной логики.

---

## Архитектура

```
cli_calculator.py        # CLI (argparse + I/O)
core_calc.py             # Ядро расчётов (единственный источник правды)
materials.json           # Материалы (плотность, цена за грамм)
pricing.json             # Правила ценообразования
```

Принцип:

> CLI → вызывает core_calc → выводит результат

### Что находится в core_calc.py
- парсинг STL / 3MF;
- расчёт объёма модели и объёма печати;
- расчёт веса;
- оценка времени печати;
- ценообразование (минималка, наценки, комиссии, НДС, округление);
- формирование текстового отчёта;
- диагностические блоки.

### Что находится в CLI
- разбор аргументов командной строки;
- выбор режима вывода (json / text);
- загрузка конфигураций;
- вывод результата.

CLI **не содержит формул и коэффициентов**.

---

## Установка

Требования:
- Python 3.10+

Установка зависимостей (если есть):

```bash
pip install -r requirements.txt
```

---

## Базовое использование

```bash
python cli_calculator.py model.stl \
  --material "PLA" \
  --infill 15
```

---

## Параметры командной строки

### Обязательные

- `model.stl | model.3mf`  
  Путь к 3D-модели.

- `--material <name>`  
  Название материала (как в `materials.json`).

- `--infill <percent>`  
  Процент заполнения (0–100).

---

### Режимы вывода

- `--json`  
  Вывод результата в JSON (для интеграций).

- `--text`  
  Человекочитаемый текстовый отчёт.

---

### Дополнительные режимы

- `--per-object`  
  Отдельный расчёт для каждого объекта в 3MF.

- `--diag`  
  Вывод диагностической информации парсинга.

- `--workers N`  
  Количество потоков для batch-обработки.

---

## Формат JSON-вывода

### Базовый режим (`--json`)

```json
{
  "success": true,
  "count": 1,
  "summary": {
    "material": "PLA",
    "volume_model_cm3": 120.5,
    "volume_print_cm3": 42.3,
    "weight_g": 52.8,
    "time_h": 3.2,
    "total_rub": 860,
    "total_raw_rub": 873.4,
    "min_applied": false
  },
  "time_s": 0.21
}
```

---

### Per-object режим (`--per-object --json`)

```json
{
  "success": true,
  "count": 2,
  "per_object": [
    {
      "file": "part1.stl",
      "volume_print_cm3": 20.1,
      "weight_g": 25.2,
      "total_rub": 430,
      "total_rounded_rub": 430
    }
  ],
  "summary": null,
  "time_s": 0.34
}
```

---

## Конфигурация

### materials.json

```json
{
  "PLA": {
    "density_g_cm3": 1.24,
    "price_rub_per_g": 2.1
  }
}
```

### pricing.json

Содержит:
- минимальный чек;
- округление;
- коэффициенты печати;
- энергозатраты;
- амортизацию;
- труд;
- риски;
- налоги и комиссии.

CLI **не интерпретирует** эти данные — он передаёт их в `core_calc.py`.

---

## Диагностика

```bash
python cli_calculator.py model.3mf --material PLA --infill 20 --diag --text
```

Выводит:
- информацию о парсинге модели;
- единицы измерения;
- количество мешей;
- найденные ошибки.

---

## Тестирование

Для регрессионной проверки используется golden-тест:

```bash
python tools/golden_compare_v6.py
```

Он гарантирует:
- совпадение расчётов old / refactored;
- корректную работу всех режимов CLI.

---

## Принципы разработки

❌ **Запрещено** добавлять расчётную логику в CLI  
✅ Все формулы — только в `core_calc.py`

❌ **Запрещено** дублировать расчёты UI / CLI  
✅ Один источник правды

❌ **Запрещено** править цифры без golden-теста  
✅ Любое изменение проверяется тестом

---

## Статус

CLI стабилен и предназначен для использования в production и автоматизации.
